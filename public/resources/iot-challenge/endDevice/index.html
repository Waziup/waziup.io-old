<!DOCTYPE html>




 <html class="no-js" lang=""> 
<head>
<script type="text/javascript">
theBaseUrl = "http://" + location.host + "/";
document.write('<base href="' + theBaseUrl + '"/>');
</script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
  <title>IoT Challenge Fish Farming - WAZIUP Platform</title>
  <meta name="generator" content="Hugo 0.18.1" />

  
  <link rel="canonical" href="./resources/iot-challenge/enddevice">
  
  <meta name="author" content="waziup.io">
  

  <meta property="og:url" content="/resources/iot-challenge/enddevice">
  <meta property="og:title" content="WAZIUP Platform">
  <meta property="og:image" content="/images/logo-waziup.png">
  <meta name="apple-mobile-web-app-title" content="WAZIUP Platform">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="shortcut icon" type="image/x-icon" href="./images/logo-waziup.png">
  <link rel="icon" type="image/x-icon" href="./images/logo-waziup.png">


  <style>
    @font-face {
      font-family: 'Icon';
      format('embedded-opentype'),
      format('woff'),
      format('truetype'),
      format('svg');
      font-weight: normal;
      font-style: normal;
    }
  </style>

  <link rel="stylesheet" href="css/style.css">

  <script src="js/vendor.js"></script>

  <script src="js/app.js"></script>

</head>
<body class="palette-primary-pink palette-accent-pink">


<div class="single-page">
  <nav aria-label="Header" id="header" class="top-menu">
  <div class="left">
    <a href="#">
      <div id="logo" class="logo"></div>
    </a>
  </div>

  <div class="center">
          <a href="./" ><img src="img/lang/gb.png" alt="English"></a>
          <a href="./fr" ><img src="img/lang/fr.png" alt="Français"></a>
  </div>

  <div class="right">
    <div class="top-menu-items" id="top-menu-items">

    </div>

    <div class="download">
      <a href="http://dashboard.waziup.io" class="button button--red">
        Try Waziup
      </a>
    </div>
    
    <a href="https://github.com/Waziup/platform" target="_blank" class="github-logo">
      <i class="fa fa-2x fa-github" aria-hidden="true"></i>
    </a>

    <div class="search-button">
      <i class="fa fa-lg fa-search"></i>
    </div>

  </div>
</nav>

<ul id="mobile-menu" style="display: none">
</ul>

<div id="search">
  <div class="search-bar">
    <div class="search-bar__back">
      <i class="fa fa-lg fa-times"></i>
    </div>
    <input class="search-bar__input" placeholder='Type your search here...'>
  </div>
  <div class="search-results">
    <ul></ul>
  </div>
</div>


</div>

<div class="page documentation">
    <div class="menu" id="side-menu">
    </div>
    <div class="content">
      <h1 class="content-header">IoT Challenge Fish Farming </h1>
      <div class="markdowned">
        

<h2 id="end-node-device">End node device</h2>

<p>Our team have already start the project for several weeks.
 Now we have the first version of our device (gateway and end device node). In this article I present the end device node with the material used, the electronic assembly and the software part.</p>

<hr />

<h2 id="electronic-part">Electronic part</h2>

<p>The end device (sensor node) is a buoy containing a box with the electronic assembly.
This device gather information about water (temperature, PH and dissolved oxygen) and send it to the IoT gateway through LoRa connection.</p>

<p>As it cannot be connect to an electrical outlet, the device needs to have his own power supply to operate.
We decide to add a battery and a solar panel wich is fixed on the top of the buoy.</p>

<p>For the microcontroller we use an arduino Pro Mini in his 3.3V version. This choice has been made for the low power comsuption of the Pro Mini, his small size and the ease of development on it (Arduino).

<figure >
    
        <img src="./images/iot-challenge/20161118_164330.jpg" />
    
    
</figure>
</p>

<p>One of the challenges in this isolated rural areas was the necessity to work over a long distance and poor infrastructure. Deploying IoT in this context must use long range wireless communication between device and gateway
and autonomous low cost energy devices. We decide to use the low-power wide area networks <em>LoRa</em>. In that purpose we add a LoRa module on the node : the inAir9 module.</p>

<p>We use the sensors atlas DO oxygen, and atlas PH for dissolved oxygen and PH measurements. The two sensors come with a small circuit to precise the measure and calibrate it (Ezo PH and Ezo DO).
This two sensors are wired to the arduino via I2C bus that is a master-slave serial bus.</p>

<p>For temperature we choose the DS28BT whom use the 1 wire bus. We also decide to add a temperature and humidity sensor into our box to detect a probable high peak of temperature or humidity which will damaged our circuit.</p>

<p>The last thing we add to the circuit is a voltage divider to get the voltage output of the battery and so control his level of charge.</p>

<p>After some prototype circuit assembly we choose to order a printed circuit board rather than directly solder the component together.</p>

<p>Below we have the circuit schema and the Pcb schema.</p>

<p>
<figure >
    
        <img src="./images/iot-challenge/circuit.png" />
    
    
    <figcaption>
        <h4>Circuit Schema</h4>
        
    </figcaption>
    
</figure>


<figure >
    
        <img src="./images/iot-challenge/pcb.png" />
    
    
    <figcaption>
        <h4>PCB Schema</h4>
        
    </figcaption>
    
</figure>
</p>

<p>During the time receiving our circuit board, we build the buoy. It is composed of a watertight box, polystyrene float and slabs of plexigas to bound the overall.
The float is blocked into two slabs of plexiglas and the box is screwed to one slab.
A rod of plastic has also been added under the buoy to attached the sensors on it. So the sensors will be fully submerged under 30 cm of water.</p>


<figure >
    
        <img src="./images/iot-challenge/box_polystyrene.png" />
    
    
</figure>


<p>And few days later we received our printed circuit board and start soldering the components.</p>


<figure >
    
        <img src="./images/iot-challenge/20170116_170718.jpg" />
    
    
    <figcaption>
        <h4>PCB Schema</h4>
        
    </figcaption>
    
</figure>


<p>After soldering, cutting and drilling this is our final box.</p>


<figure >
    
        <img src="./images/iot-challenge/final_box.png" />
    
    
    <figcaption>
        <h4>Final Box</h4>
        
    </figcaption>
    
</figure>


<hr />

<h2 id="software-part">Software part</h2>

<h3 id="library-used">Library Used</h3>

<p>To communicate via I2C bus between PH sensor, DO sensor and the Arduino , we use the <a href="https://www.arduino.cc/en/Reference/Wire">wire</a> library.</p>

<p>One of the tricky part was to handle LoRa communication with the gateway. We use this <a href="https://github.com/CongducPham/LowCostLoRaGw">LoRa library</a> which greatly facilitated the work. This library is developed by Congduc Pham who is also member of the Waziup Project.</p>

<h3 id="power-save">Power save</h3>

<p>One of the biggest constraint we face is the necessity to save power.
So we decide to get data from sensor at a rate of about 2 reads by hour. The rest of the time the microcontroller and the sensors need to be in a kind of &ldquo;sleep mode&rdquo;. However we choose to not using the sleep mode avalaible on the sensors (PH and DO) which still consume a little.
 We just cut off the supply when needed.</p>

<p>On the arduino the sleep mode is assisted by interrupts, without them just a reset can wake the Arduino up.
In our case we use the watchdog timer interrupt to handle the sleep mode.
The watch dog timer is a small timer that force a full system restart if it not receive an &ldquo;ok&rdquo; signal from the microcontroller. The advantage of this timer is
that it&rsquo;s always runing even when the system is entirely put in sleep mode. So it&rsquo;s a good way to control and wake up the system periodically.</p>

<h3 id="system-failure">System failure</h3>

<p>We also use the watchdog timer in his main purpose : detect and recover from computer malfunction. In case of unstable loops the watchdog wont receive an &ldquo;ok&rdquo; signal from the microcontroller
and so will trigger a reboot of the arduino. It prevents hardware or software failure.</p>

<p>Unfortunately I have spent several hours debugging an annoying issue with the Arduino Pro Mini watchdog timer. I finally find out that the issue didn&rsquo;t come from my code, but from the original bootloader
of my Arduino board.</p>

<p>I simulate an infinite loop that trigger the watchdog but instead of reseting once the arduino, it blocks the bootloader into an infinite reset loop.
And so nothing works anymore on the Arduino:
I cannot upload new Sketch and cannot reset the arduino manually with the reset button. I had to disconnect the power to recover the Arduino.
The solution I used is to flash a new bootloader on the board. I took the bootloader (optiboot) of the Arduino UNO which uses the same chip (atmega328) as the arduino Pro Mini and it solves the problem.</p>

      </div>
    </div>
</div>

<div class="lander-row lander-row--blue footer">
  <div class="container">
    <div class="row">
      <div class="col col-3">
        <h2 class="h2">Learn More</h2>
        <a href='./why-use-waziup/'>
          <p class="text">Why use Waziup?</p>
        </a>
        <a href='./documentation/how-waziup-works/'>
          <p class="text">Documentation</p>
        </a>
        <a href='./about'>
          <p class="text">About us</p>
        </a>
        <a href='./resources/news/'>
          <p class="text">News</p>
        </a>
        <a href='./contact'>
          <p class="text">Contact</p>
        </a>
      </div>
        <div class="col col-6">
        <h2 class="h2">All things code</h2>
          <a href='./support'>
            <p class="text">Support</p>
          </a>
          <a href='./resources/community'>
            <p class="text">Community</p>
          </a>
          <a href="https://github.com/waziup/platform" target="_blank">
            <p class="text">GitHub</p>
          </a>
      </div>
      <div class="col col-6">
        <h2 class="h2">Stay up to date</h2>
        <p class="text">
          Leave your email for the latest news: We won’t spam you and won’t go off topic.
        </p>

        

        <div class="social-buttons">
          <p class="text">Follow us on</p>
          <a href="https://twitter.com/waziupIOT" target="_blank">
            <i class="fa fa-2x fa-twitter"></i>
          </a>

          <a href="https://www.linkedin.com/company/magnetic-io" target="_blank">
            <i class="fa fa-2x fa-linkedin"></i>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="footer-bottom lander-row--blue">
  <div class="container">
    <div class="part">
      <a href='./about'><img class="waziup-logo" src="./img/005-waziup/Logo/logo-waziup-white.svg" alt=""></a>
    </div>

    <div class="part">
      <a href="./" class="button button--red" style="text-decoration:none">
        English
      </a>
    </div>

    <div class="part">
      <p class="text">Code licensed under<a type="application/rss+xml" href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank">Apache 2</a> © 2016 <a href='./about'>Waziup.io</a></p>
    </div>
  </div>
</div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59948816-1', 'auto');
  ga('send', 'pageview');

</script>

